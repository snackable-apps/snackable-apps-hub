<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Admin - Snackable Games</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¨</text></svg>">
  <style>
    :root {
      --bg-color: #0f0f1a;
      --card-bg: #1a1a2e;
      --text-color: #fff;
      --text-muted: #9ca3af;
      --border-color: #2d2d3d;
      --primary-color: #00d4ff;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      font-size: 14px;
    }
    
    /* Header */
    .header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .back-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .back-link:hover { color: var(--primary-color); }
    
    .header h1 {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-color);
      transition: all 0.15s;
    }
    
    .btn:hover { background: var(--border-color); }
    
    .btn-danger {
      border-color: var(--error-color);
      color: var(--error-color);
    }
    
    .btn-danger:hover {
      background: var(--error-color);
      color: white;
    }
    
    .btn-success {
      border-color: var(--success-color);
      color: var(--success-color);
    }
    
    .btn-success:hover {
      background: var(--success-color);
      color: white;
    }
    
    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-box {
      background: var(--card-bg);
      padding: 32px;
      border-radius: 12px;
      width: 100%;
      max-width: 360px;
      border: 1px solid var(--border-color);
    }
    
    .login-box h2 {
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.25rem;
    }
    
    .login-box input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .login-box button {
      width: 100%;
      padding: 10px;
      border: none;
      background: var(--primary-color);
      color: white;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .login-box button:hover { opacity: 0.9; }
    
    .login-error {
      color: var(--error-color);
      text-align: center;
      margin-top: 12px;
      font-size: 13px;
      display: none;
    }
    
    .login-back {
      text-align: center;
      margin-top: 16px;
    }
    
    .login-back a {
      color: var(--text-muted);
      font-size: 13px;
      text-decoration: none;
    }
    
    .login-back a:hover { color: var(--primary-color); }
    
    /* Main Container */
    .main {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }
    
    .main.active { display: block; }
    
    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .toolbar select, .toolbar input {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      border-radius: 4px;
      font-size: 13px;
    }
    
    .toolbar select { min-width: 120px; }
    
    .toolbar .search-input {
      flex: 1;
      min-width: 150px;
      max-width: 250px;
    }
    
    .toolbar .spacer { flex: 1; }
    
    .stats-inline {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .stats-inline span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stats-inline .count {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    /* Table Layout */
    .table-container {
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table th {
      background: var(--bg-color);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      position: sticky;
      top: 0;
    }
    
    .table tr:last-child td { border-bottom: none; }
    
    .table tr:hover { background: rgba(255,255,255,0.02); }
    
    .table tr.tackled { opacity: 0.5; }
    
    .table .col-game { width: 100px; }
    .table .col-topic { width: 90px; }
    .table .col-message { }
    .table .col-email { width: 150px; }
    .table .col-date { width: 140px; }
    .table .col-actions { width: 120px; text-align: right; }
    
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .tag-game {
      background: var(--primary-color);
      color: white;
    }
    
    .tag-topic {
      background: var(--border-color);
      color: var(--text-color);
    }
    
    .message-cell {
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .message-cell.expanded {
      white-space: normal;
      word-break: break-word;
    }
    
    .email-cell {
      color: var(--primary-color);
      font-size: 12px;
    }
    
    .date-cell {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .actions-cell {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
    }
    
    .actions-cell .btn { padding: 4px 8px; }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .table .col-email { display: none; }
      .table .col-date { width: 100px; }
      .header h1 { font-size: 1rem; }
    }
    
    @media (max-width: 500px) {
      .toolbar { flex-direction: column; }
      .toolbar select, .toolbar .search-input { width: 100%; max-width: none; }
      .stats-inline { justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="login-screen">
    <div class="login-box">
      <h2>üì¨ Feedback Admin</h2>
      <input type="password" id="password-input" placeholder="Enter admin password" autofocus>
      <button onclick="login()">Login</button>
      <p class="login-error" id="login-error">Invalid password</p>
      <div class="login-back">
        <a href="../">‚Üê Back to Games</a>
      </div>
    </div>
  </div>
  
  <!-- Dashboard -->
  <div class="main" id="main">
    <div class="header">
      <div class="header-left">
        <a href="../" class="back-link">‚Üê Games</a>
        <h1>üì¨ Feedback Admin</h1>
      </div>
      <div class="header-right">
        <a href="../data-explorer/" class="btn">üìä Data Explorer</a>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div style="padding: 16px;">
      <div class="toolbar">
        <select id="filter-game" onchange="loadFeedback()">
          <option value="">All Games</option>
          <option value="F1 Quiz">F1 Quiz</option>
          <option value="Tennis Quiz">Tennis Quiz</option>
          <option value="FutQuiz">FutQuiz</option>
          <option value="Music Quiz">Music Quiz</option>
          <option value="Blind Test">Blind Test</option>
          <option value="Movies Quiz">Movies Quiz</option>
          <option value="Animal Quiz">Animal Quiz</option>
          <option value="Books Quiz">Books Quiz</option>
          <option value="Sudoku">Sudoku</option>
          <option value="General / Website">General</option>
        </select>
        <select id="filter-topic" onchange="loadFeedback()">
          <option value="">All Topics</option>
          <option value="Bug Report">Bug Report</option>
          <option value="Suggestion">Suggestion</option>
          <option value="Data Issue">Data Issue</option>
          <option value="Other">Other</option>
        </select>
        <select id="filter-tackled" onchange="loadFeedback()">
          <option value="">All Status</option>
          <option value="false">New</option>
          <option value="true">Tackled</option>
        </select>
        <input type="text" class="search-input" id="search-input" placeholder="Search messages..." oninput="filterLocal()">
        <div class="spacer"></div>
        <div class="stats-inline">
          <span>Total: <span class="count" id="stat-total">0</span></span>
          <span>New: <span class="count" id="stat-new">0</span></span>
        </div>
      </div>
      
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th class="col-game">Game</th>
              <th class="col-topic">Topic</th>
              <th class="col-message">Message</th>
              <th class="col-email">Email</th>
              <th class="col-date">Date</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody id="feedback-tbody">
            <tr><td colspan="6" class="no-data">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = 'https://snackable-api.vercel.app/api';
    const TOKEN_KEY = 'admin-auth-token'; // Shared with Data Explorer
    let authToken = null;
    let allFeedback = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      const savedToken = sessionStorage.getItem(TOKEN_KEY);
      if (savedToken) {
        validateToken(savedToken);
      }
      
      document.getElementById('password-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
    });
    
    async function validateToken(token) {
      try {
        const response = await fetch(`${API_BASE}/auth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'validate', token })
        });
        const data = await response.json();
        if (data.valid) {
          authToken = token;
          showDashboard();
        }
      } catch (e) {
        console.error('Token validation failed:', e);
      }
    }
    
    async function login() {
      const password = document.getElementById('password-input').value;
      const errorEl = document.getElementById('login-error');
      errorEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE}/auth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'login', password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          authToken = data.token;
          sessionStorage.setItem(TOKEN_KEY, authToken);
          showDashboard();
        } else {
          errorEl.style.display = 'block';
          errorEl.textContent = data.error || 'Invalid password';
        }
      } catch (e) {
        errorEl.style.display = 'block';
        errorEl.textContent = 'Connection error';
      }
    }
    
    function logout() {
      authToken = null;
      sessionStorage.removeItem(TOKEN_KEY);
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main').classList.remove('active');
      document.getElementById('password-input').value = '';
    }
    
    function showDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main').classList.add('active');
      loadFeedback();
    }
    
    async function loadFeedback() {
      const tbody = document.getElementById('feedback-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="no-data">Loading...</td></tr>';
      
      const game = document.getElementById('filter-game').value;
      const topic = document.getElementById('filter-topic').value;
      const tackled = document.getElementById('filter-tackled').value;
      
      const params = new URLSearchParams();
      if (game) params.append('game', game);
      if (tackled) params.append('tackled', tackled);
      params.append('limit', '200');
      
      try {
        const response = await fetch(`${API_BASE}/feedback-admin?${params}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.status === 401) {
          logout();
          return;
        }
        
        const data = await response.json();
        allFeedback = data.feedback || [];
        
        // Client-side topic filter (API might not support it yet)
        if (topic) {
          allFeedback = allFeedback.filter(f => f.topic === topic);
        }
        
        updateStats();
        filterLocal();
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading feedback</td></tr>';
        console.error('Load error:', e);
      }
    }
    
    function updateStats() {
      document.getElementById('stat-total').textContent = allFeedback.length;
      document.getElementById('stat-new').textContent = allFeedback.filter(f => !f.tackled).length;
    }
    
    function filterLocal() {
      const search = document.getElementById('search-input').value.toLowerCase();
      let filtered = allFeedback;
      
      if (search) {
        filtered = allFeedback.filter(f => 
          f.message?.toLowerCase().includes(search) ||
          f.email?.toLowerCase().includes(search)
        );
      }
      
      renderTable(filtered);
    }
    
    function renderTable(feedback) {
      const tbody = document.getElementById('feedback-tbody');
      
      if (!feedback || feedback.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No feedback found</td></tr>';
        return;
      }
      
      tbody.innerHTML = feedback.map(f => {
        const date = new Date(f.created_at).toLocaleDateString('en-GB', {
          day: '2-digit', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const tackledClass = f.tackled ? 'tackled' : '';
        const topicLabel = f.topic ? capitalizeWords(f.topic) : '';
        
        return `
          <tr class="${tackledClass}" id="row-${f.id}">
            <td><span class="tag tag-game">${escapeHtml(f.game)}</span></td>
            <td>${topicLabel ? `<span class="tag tag-topic">${escapeHtml(topicLabel)}</span>` : '-'}</td>
            <td class="message-cell" onclick="this.classList.toggle('expanded')" title="Click to expand">${escapeHtml(f.message)}</td>
            <td class="email-cell">${f.email ? escapeHtml(f.email) : '-'}</td>
            <td class="date-cell">${date}</td>
            <td class="actions-cell">
              <button class="btn btn-success" onclick="toggleTackled('${f.id}', ${!f.tackled})" title="${f.tackled ? 'Untackle' : 'Mark Tackled'}">
                ${f.tackled ? '‚Ü©' : '‚úì'}
              </button>
              <button class="btn btn-danger" onclick="deleteFeedback('${f.id}')" title="Delete">üóë</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function capitalizeWords(str) {
      return str.replace(/\b\w/g, c => c.toUpperCase());
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function toggleTackled(id, tackled) {
      try {
        const response = await fetch(`${API_BASE}/feedback-admin`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ id, tackled })
        });
        
        if (response.ok) {
          // Update local data instead of refetching
          const item = allFeedback.find(f => f.id === id);
          if (item) item.tackled = tackled;
          updateStats();
          filterLocal();
        }
      } catch (e) {
        console.error('Update error:', e);
      }
    }
    
    async function deleteFeedback(id) {
      if (!confirm('Delete this feedback?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/feedback-admin`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ id })
        });
        
        if (response.ok) {
          allFeedback = allFeedback.filter(f => f.id !== id);
          updateStats();
          filterLocal();
        }
      } catch (e) {
        console.error('Delete error:', e);
      }
    }
  </script>
</body>
</html>
